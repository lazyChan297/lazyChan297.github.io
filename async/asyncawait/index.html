<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Async异步函数 | 297 blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="297 blog">
    
    <link rel="preload" href="/assets/css/0.styles.f0eb3862.css" as="style"><link rel="preload" href="/assets/js/app.5ec938e9.js" as="script"><link rel="preload" href="/assets/js/2.270d282d.js" as="script"><link rel="preload" href="/assets/js/43.e3eda78c.js" as="script"><link rel="prefetch" href="/assets/js/10.8068544d.js"><link rel="prefetch" href="/assets/js/11.b810643b.js"><link rel="prefetch" href="/assets/js/12.5a23f3ee.js"><link rel="prefetch" href="/assets/js/13.22368437.js"><link rel="prefetch" href="/assets/js/14.b308de21.js"><link rel="prefetch" href="/assets/js/15.6b48e774.js"><link rel="prefetch" href="/assets/js/16.b7999003.js"><link rel="prefetch" href="/assets/js/17.d410c546.js"><link rel="prefetch" href="/assets/js/18.82fd31d6.js"><link rel="prefetch" href="/assets/js/19.c5176c2d.js"><link rel="prefetch" href="/assets/js/20.990b9bd4.js"><link rel="prefetch" href="/assets/js/21.aa205aaa.js"><link rel="prefetch" href="/assets/js/22.d47a8271.js"><link rel="prefetch" href="/assets/js/23.8380b2de.js"><link rel="prefetch" href="/assets/js/24.60d1daa2.js"><link rel="prefetch" href="/assets/js/25.7a10d331.js"><link rel="prefetch" href="/assets/js/26.46886c91.js"><link rel="prefetch" href="/assets/js/27.ef38de8b.js"><link rel="prefetch" href="/assets/js/28.322751d6.js"><link rel="prefetch" href="/assets/js/29.64bc9c06.js"><link rel="prefetch" href="/assets/js/3.7585634d.js"><link rel="prefetch" href="/assets/js/30.44440b28.js"><link rel="prefetch" href="/assets/js/31.1e6e9318.js"><link rel="prefetch" href="/assets/js/32.637d364b.js"><link rel="prefetch" href="/assets/js/33.8dc57b3a.js"><link rel="prefetch" href="/assets/js/34.0b3bc232.js"><link rel="prefetch" href="/assets/js/35.e633d5d3.js"><link rel="prefetch" href="/assets/js/36.3a11361b.js"><link rel="prefetch" href="/assets/js/37.42dbf4bc.js"><link rel="prefetch" href="/assets/js/38.15b0e4ce.js"><link rel="prefetch" href="/assets/js/39.0abb7d14.js"><link rel="prefetch" href="/assets/js/4.6e45c2f6.js"><link rel="prefetch" href="/assets/js/40.da63ea83.js"><link rel="prefetch" href="/assets/js/41.f41c6635.js"><link rel="prefetch" href="/assets/js/42.dc07c7a5.js"><link rel="prefetch" href="/assets/js/44.4322f952.js"><link rel="prefetch" href="/assets/js/45.54eb0056.js"><link rel="prefetch" href="/assets/js/46.9e575786.js"><link rel="prefetch" href="/assets/js/47.0abc400f.js"><link rel="prefetch" href="/assets/js/48.b1278165.js"><link rel="prefetch" href="/assets/js/49.9b4ff511.js"><link rel="prefetch" href="/assets/js/5.3f6386b3.js"><link rel="prefetch" href="/assets/js/50.b89e4e9c.js"><link rel="prefetch" href="/assets/js/51.d4385674.js"><link rel="prefetch" href="/assets/js/52.be50eece.js"><link rel="prefetch" href="/assets/js/53.2f647cc9.js"><link rel="prefetch" href="/assets/js/54.1e5f5b4f.js"><link rel="prefetch" href="/assets/js/55.4695b127.js"><link rel="prefetch" href="/assets/js/56.27ddab6e.js"><link rel="prefetch" href="/assets/js/57.05cf4bba.js"><link rel="prefetch" href="/assets/js/58.41834c36.js"><link rel="prefetch" href="/assets/js/59.cbb32889.js"><link rel="prefetch" href="/assets/js/6.437b8f0c.js"><link rel="prefetch" href="/assets/js/60.e368c66a.js"><link rel="prefetch" href="/assets/js/61.367e9e4c.js"><link rel="prefetch" href="/assets/js/62.9d13d61c.js"><link rel="prefetch" href="/assets/js/63.cad5f803.js"><link rel="prefetch" href="/assets/js/64.e6db2d9c.js"><link rel="prefetch" href="/assets/js/65.499322b1.js"><link rel="prefetch" href="/assets/js/66.249a3118.js"><link rel="prefetch" href="/assets/js/67.f35b76a0.js"><link rel="prefetch" href="/assets/js/68.86cea2f9.js"><link rel="prefetch" href="/assets/js/69.e5794e36.js"><link rel="prefetch" href="/assets/js/7.b57c72fc.js"><link rel="prefetch" href="/assets/js/70.6bc69b96.js"><link rel="prefetch" href="/assets/js/71.cbfef801.js"><link rel="prefetch" href="/assets/js/72.17cdb10f.js"><link rel="prefetch" href="/assets/js/73.bf783174.js"><link rel="prefetch" href="/assets/js/74.c35d9540.js"><link rel="prefetch" href="/assets/js/75.b1202a71.js"><link rel="prefetch" href="/assets/js/76.76639e56.js"><link rel="prefetch" href="/assets/js/77.8788b0e1.js"><link rel="prefetch" href="/assets/js/78.d9125cf4.js"><link rel="prefetch" href="/assets/js/8.c40ec890.js"><link rel="prefetch" href="/assets/js/9.023b1a72.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f0eb3862.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">297 blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>异步编程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/async/asyncawait/" aria-current="page" class="active sidebar-link">Async异步函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/async/asyncawait/#async" class="sidebar-link">async</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/async/asyncawait/#返回值" class="sidebar-link">返回值</a></li></ul></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#await" class="sidebar-link">await</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/async/asyncawait/#返回值-2" class="sidebar-link">返回值</a></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#返回值对async函数执行的影响" class="sidebar-link">返回值对async函数执行的影响</a></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#捕获错误" class="sidebar-link">捕获错误</a></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#多个await" class="sidebar-link">多个await</a></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#不要在foreach中使用async-await" class="sidebar-link">不要在forEach中使用async await</a></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#与generator的区别" class="sidebar-link">与Generator的区别</a></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#与promise的区别" class="sidebar-link">与Promise的区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/async/asyncawait/#async实现原理" class="sidebar-link">async实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/async/asyncawait/#自动执行器的实现思路" class="sidebar-link">自动执行器的实现思路</a></li></ul></li></ul></li><li><a href="/async/js-promise/" class="sidebar-link">Promise</a></li><li><a href="/async/generator/" class="sidebar-link">Generator</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>algorithm</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue源码学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="async异步函数"><a href="#async异步函数" class="header-anchor">#</a> Async异步函数</h1> <h2 id="async"><a href="#async" class="header-anchor">#</a> async</h2> <p>异步处理函数，<code>generator</code>函数的语法糖</p> <h3 id="返回值"><a href="#返回值" class="header-anchor">#</a> 返回值</h3> <p>async函数的返回值是一个promise对象，所以可以使用promise的回调方法<br></p> <p>如果有抛出错误，则剩下的代码不会执行，
返回值：状态为rejected的promise对象，promise对象的值是抛出的错误</p> <p>如果有显示返回值，剩下的代码也不会执行，
返回值：状态fulfilled为promise对象，promise对象的值就是返回的值</p> <p>除了抛出错误和显示的return之外，只有等函数体内所有的await函数执行完毕，
返回值promise的状态才会改变，<code>async</code>函数才可以调用<code>then</code>方法</p> <h2 id="await"><a href="#await" class="header-anchor">#</a> await</h2> <p>await用来执行需要异步处理的函数，await命令后的代码会被注册到微任务队列（执行时机通过事件循环来决定）</p> <h3 id="返回值-2"><a href="#返回值-2" class="header-anchor">#</a> 返回值</h3> <p>如果await命令后是一个promise对象 返回它promise对象的值，注意不是返回promise对象，如果不是promise对象则返回值本身</p> <h3 id="返回值对async函数执行的影响"><a href="#返回值对async函数执行的影响" class="header-anchor">#</a> 返回值对async函数执行的影响</h3> <ul><li>返回值是promise对象的情况，如果是resolve，剩下的代码仍然会注册到微任务执行；如果是rejected，不会执行</li> <li>返回值是非promise对象，会返回该对象，剩下的代码也会注册到微任务执行</li></ul> <h3 id="捕获错误"><a href="#捕获错误" class="header-anchor">#</a> 捕获错误</h3> <p>方法1：async标识的函数中用<code>catch</code>捕获<br>
方法2：await命令后面的函数用<code>catch</code>捕获<br>
这两种方式使用和<code>promise</code>捕获错误是相同的，如果想要await命令后的函数被<code>rejected</code>后仍然继续执行，可以使用<code>try{}catch(e){}</code>代码块包裹</p> <h3 id="多个await"><a href="#多个await" class="header-anchor">#</a> 多个await</h3> <p>当<code>async</code>函数中有多个<code>await</code>异步方法时，如果方法间不存在继发关系可以用以下写法 <br>
这样子写作用在于两个独立的请求函数可以同时进行</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token keyword">async</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> userName <span class="token operator">=</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> userId <span class="token operator">=</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> userName
        <span class="token keyword">await</span> userId
        <span class="token keyword">return</span> <span class="token punctuation">{</span>userName<span class="token punctuation">,</span> userId<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>也可以使用<code>Promise.all[]</code>来处理多个并发异步请求的问题</p> <h3 id="不要在foreach中使用async-await"><a href="#不要在foreach中使用async-await" class="header-anchor">#</a> 不要在forEach中使用async await</h3> <p>因为<code>forEach</code>的回调函数会变为普通函数</p> <h3 id="与generator的区别"><a href="#与generator的区别" class="header-anchor">#</a> 与Generator的区别</h3> <p>generator函数必须通过任务执行器（可以理解为generator函数的返回值）调用执行，<br>
或者遍历generator调用执行，而async可以自动执行</p> <h3 id="与promise的区别"><a href="#与promise的区别" class="header-anchor">#</a> 与Promise的区别</h3> <ol><li>在代码结构上，<code>async</code>会比<code>promise</code>函数更加清晰</li> <li>处理并发请求的时候Promise有很多种方法支持，例如<code>race</code>&amp;<code>all</code>&amp;<code>allSettled</code>，async没有专门的方法处理</li></ol> <h2 id="async实现原理"><a href="#async实现原理" class="header-anchor">#</a> async实现原理</h2> <p>async的generator的语法糖，区别只在于async可以自动执行，<br>
不需要像generator一样调用任务执行器，<br>
所以只需要实现一个generator的自动执行器，<br>
就可以实现<code>async</code></p> <p><strong>async函数的返回值是调用了自动执行器函数spawn，把包裹了async函数体的generator函数作为参数传入，spawn执行后会返回一个promise对象，promise对象的构造函数中会做三件事</strong></p> <ol><li>执行传入的函数参数也就是generator，返回返回一个generator函数遍历器gen</li> <li>创建分步函数step。step接收一个函数作为参数，然后调用函数的next方法，同时用next变量保存执行结果。接着判断next.done是否为true，如果是就会执行resolve方法，把返回的promise对象状态变为fulfilled，使async函数的返回值then回调得以执行；如果不为true，会把next.value包装成一个promise.resolve对象，在该对象的then回调中递归调用分步函数，传入的参数是一个匿名函数，函数体内执行函数遍历器的next方法</li> <li>定义好gen函数遍历器和分步函数后，会调用分步函数，传入的值是一个匿名函数，函数体指向<code>gen.next(undefined)</code>，next方法的传参是代替上一次调用<code>yield</code>命令返回的结果，因为是第一次调用，所以传入undefined。</li></ol> <h3 id="自动执行器的实现思路"><a href="#自动执行器的实现思路" class="header-anchor">#</a> 自动执行器的实现思路</h3> <ol><li>返回一个promise对象，因为<code>async</code>函数的返回值就是promise对象</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">genF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>获取<code>generator</code>函数的任务运行器，<br> <code>spawn</code>的入参<code>genF</code>就是<code>generator</code>函数</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">genF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">genF</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>创建一个递归函数<code>step</code>，自动调用任务执行器的核心;</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nextFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// next缓存每次gen.next()的返回值 </span>
    <span class="token keyword">let</span> next<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        next <span class="token operator">=</span> <span class="token function">nextFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 运行报错，async函数的返回值直接被rejected</span>
        <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// yield已经全部执行完毕,async函数的返回值被resolved</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 继续执行剩下的yield</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// value返回值被resolve</span>
            gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            gen<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>运行递归函数<code>step</code>，实现自动运行</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">genF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...忽略部分代码</span>
            <span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">nextFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token comment">// 因为第一次调用next的参数无效，所以传undefined</span>
            <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>完整代码</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 等同于</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">genF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.1 获取任务执行器</span>
        <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">getF</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">nextF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> next<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                next <span class="token operator">=</span> <span class="token function">nextF</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">rejected</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 已经全部执行了yield表达式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">step</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">step</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> gen<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">step</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/basic/js-scope/" class="prev">
        作用域
      </a></span> <span class="next"><a href="/async/js-promise/">
        Promise
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5ec938e9.js" defer></script><script src="/assets/js/2.270d282d.js" defer></script><script src="/assets/js/43.e3eda78c.js" defer></script>
  </body>
</html>
