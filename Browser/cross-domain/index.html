<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>跨域 | 297 blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="297 blog">
    
    <link rel="preload" href="/assets/css/0.styles.f0eb3862.css" as="style"><link rel="preload" href="/assets/js/app.5ec938e9.js" as="script"><link rel="preload" href="/assets/js/2.270d282d.js" as="script"><link rel="preload" href="/assets/js/11.b810643b.js" as="script"><link rel="prefetch" href="/assets/js/10.8068544d.js"><link rel="prefetch" href="/assets/js/12.5a23f3ee.js"><link rel="prefetch" href="/assets/js/13.22368437.js"><link rel="prefetch" href="/assets/js/14.b308de21.js"><link rel="prefetch" href="/assets/js/15.6b48e774.js"><link rel="prefetch" href="/assets/js/16.b7999003.js"><link rel="prefetch" href="/assets/js/17.d410c546.js"><link rel="prefetch" href="/assets/js/18.82fd31d6.js"><link rel="prefetch" href="/assets/js/19.c5176c2d.js"><link rel="prefetch" href="/assets/js/20.990b9bd4.js"><link rel="prefetch" href="/assets/js/21.aa205aaa.js"><link rel="prefetch" href="/assets/js/22.d47a8271.js"><link rel="prefetch" href="/assets/js/23.8380b2de.js"><link rel="prefetch" href="/assets/js/24.60d1daa2.js"><link rel="prefetch" href="/assets/js/25.7a10d331.js"><link rel="prefetch" href="/assets/js/26.46886c91.js"><link rel="prefetch" href="/assets/js/27.ef38de8b.js"><link rel="prefetch" href="/assets/js/28.322751d6.js"><link rel="prefetch" href="/assets/js/29.64bc9c06.js"><link rel="prefetch" href="/assets/js/3.7585634d.js"><link rel="prefetch" href="/assets/js/30.44440b28.js"><link rel="prefetch" href="/assets/js/31.1e6e9318.js"><link rel="prefetch" href="/assets/js/32.637d364b.js"><link rel="prefetch" href="/assets/js/33.8dc57b3a.js"><link rel="prefetch" href="/assets/js/34.0b3bc232.js"><link rel="prefetch" href="/assets/js/35.e633d5d3.js"><link rel="prefetch" href="/assets/js/36.3a11361b.js"><link rel="prefetch" href="/assets/js/37.42dbf4bc.js"><link rel="prefetch" href="/assets/js/38.15b0e4ce.js"><link rel="prefetch" href="/assets/js/39.0abb7d14.js"><link rel="prefetch" href="/assets/js/4.6e45c2f6.js"><link rel="prefetch" href="/assets/js/40.da63ea83.js"><link rel="prefetch" href="/assets/js/41.f41c6635.js"><link rel="prefetch" href="/assets/js/42.dc07c7a5.js"><link rel="prefetch" href="/assets/js/43.e3eda78c.js"><link rel="prefetch" href="/assets/js/44.4322f952.js"><link rel="prefetch" href="/assets/js/45.54eb0056.js"><link rel="prefetch" href="/assets/js/46.9e575786.js"><link rel="prefetch" href="/assets/js/47.0abc400f.js"><link rel="prefetch" href="/assets/js/48.b1278165.js"><link rel="prefetch" href="/assets/js/49.9b4ff511.js"><link rel="prefetch" href="/assets/js/5.3f6386b3.js"><link rel="prefetch" href="/assets/js/50.b89e4e9c.js"><link rel="prefetch" href="/assets/js/51.d4385674.js"><link rel="prefetch" href="/assets/js/52.be50eece.js"><link rel="prefetch" href="/assets/js/53.2f647cc9.js"><link rel="prefetch" href="/assets/js/54.1e5f5b4f.js"><link rel="prefetch" href="/assets/js/55.4695b127.js"><link rel="prefetch" href="/assets/js/56.27ddab6e.js"><link rel="prefetch" href="/assets/js/57.05cf4bba.js"><link rel="prefetch" href="/assets/js/58.41834c36.js"><link rel="prefetch" href="/assets/js/59.cbb32889.js"><link rel="prefetch" href="/assets/js/6.437b8f0c.js"><link rel="prefetch" href="/assets/js/60.e368c66a.js"><link rel="prefetch" href="/assets/js/61.367e9e4c.js"><link rel="prefetch" href="/assets/js/62.9d13d61c.js"><link rel="prefetch" href="/assets/js/63.cad5f803.js"><link rel="prefetch" href="/assets/js/64.e6db2d9c.js"><link rel="prefetch" href="/assets/js/65.499322b1.js"><link rel="prefetch" href="/assets/js/66.249a3118.js"><link rel="prefetch" href="/assets/js/67.f35b76a0.js"><link rel="prefetch" href="/assets/js/68.86cea2f9.js"><link rel="prefetch" href="/assets/js/69.e5794e36.js"><link rel="prefetch" href="/assets/js/7.b57c72fc.js"><link rel="prefetch" href="/assets/js/70.6bc69b96.js"><link rel="prefetch" href="/assets/js/71.cbfef801.js"><link rel="prefetch" href="/assets/js/72.17cdb10f.js"><link rel="prefetch" href="/assets/js/73.bf783174.js"><link rel="prefetch" href="/assets/js/74.c35d9540.js"><link rel="prefetch" href="/assets/js/75.b1202a71.js"><link rel="prefetch" href="/assets/js/76.76639e56.js"><link rel="prefetch" href="/assets/js/77.8788b0e1.js"><link rel="prefetch" href="/assets/js/78.d9125cf4.js"><link rel="prefetch" href="/assets/js/8.c40ec890.js"><link rel="prefetch" href="/assets/js/9.023b1a72.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f0eb3862.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">297 blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>algorithm</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue源码学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Browser/Operation/" class="sidebar-link">浏览器运行机制</a></li><li><a href="/Browser/Caching/" class="sidebar-link">浏览器缓存机制</a></li><li><a href="/Browser/garbageCollection/" class="sidebar-link">v8引擎垃圾回收机制</a></li><li><a href="/Browser/MemoryLeak/" class="sidebar-link">内存泄漏</a></li><li><a href="/Browser/safety/" class="sidebar-link">安全防范</a></li><li><a href="/Browser/cross-domain/" aria-current="page" class="active sidebar-link">跨域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Browser/cross-domain/#同源策略" class="sidebar-link">同源策略</a></li><li class="sidebar-sub-header"><a href="/Browser/cross-domain/#解决跨域的方式" class="sidebar-link">解决跨域的方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Browser/cross-domain/#jsonp" class="sidebar-link">jsonp</a></li><li class="sidebar-sub-header"><a href="/Browser/cross-domain/#cors" class="sidebar-link">cors</a></li><li class="sidebar-sub-header"><a href="/Browser/cross-domain/#nginx代理转发" class="sidebar-link">nginx代理转发</a></li><li class="sidebar-sub-header"><a href="/Browser/cross-domain/#开发过程的跨域处理" class="sidebar-link">开发过程的跨域处理</a></li></ul></li></ul></li><li><a href="/Browser/WhiteScreen/" class="sidebar-link">白屏现象</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="跨域"><a href="#跨域" class="header-anchor">#</a> 跨域</h1> <p>由于浏览器同源策略限制，当前客户端向不是它自身服务器发起的通信称之为跨域</p> <h2 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h2> <p><code>协议</code> <code>域名</code> <code>端口号</code>，只要三者其中之一不同则称为跨域。<br></p> <p>浏览器同源策略限制的目的是为了提高安全性，</p> <ul><li>假如客户端被csrf攻击得到客户端用户的cookie，或者cookie是明文传输的，没有限制那么攻击者就可以随意冒充用户向服务器发起请求，但并不意味着同源策略就完美的杜绝了该攻击，只是增加了攻击成本</li> <li>假如使用iframe标签嵌套了客户端域名，那么可以就可以通过<code>window.frames[frameName]</code>获取客户端域名下的所有dom节点</li></ul> <h2 id="解决跨域的方式"><a href="#解决跨域的方式" class="header-anchor">#</a> 解决跨域的方式</h2> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> jsonp</h3> <p>基于script标签不会有同源策略限制的原理实现的，请求到非同源的js文件执行，所以jsonp被限制只能使用get请求。</p> <h3 id="cors"><a href="#cors" class="header-anchor">#</a> cors</h3> <p>跨域资源共享，需要服务器设置支持才能允许跨域。浏览器发起的请求区分为简单请求和非简单请求，对这两种类型也会作出不同的处理</p> <h4 id="简单请求"><a href="#简单请求" class="header-anchor">#</a> 简单请求</h4> <ul><li>请求方法是<code>get</code> <code>post</code> <code>head</code>其中一种，</li> <li>http请求头不能超过<code>accept</code> <code>Accept-Language</code> <code>Content-Language</code> <code>Last-Event-ID</code> <code>Content-Type</code>(只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain)</li></ul> <p>浏览器会直接发出简单请求，会在请求头中添加<code>Origin</code>为当前发起请求的url，服务器接收到请求后判断该<code>Origin</code>是否在许可范围内，如果不在许可范围内，<br>
服务器还是会返回一个正常的http回应，所以是不能通过状态码判断是否成功的。<br>
返回的响应头还会携带<code>Access-Control-Allow-Origin</code>，如果在许可范围内，该字段里的值就会包含刚刚发起请求的url或者是<code>*</code>，表示不限制访问。<br></p> <p>此外，还有几个字段需要注意的，</p> <ul><li><p>Access-Control-Allow-Credentials
表示是否允许cookie发送，如果服务器设置了该值为true，那么js中也要对相应的属性<code>withCredentials</code>设置为true，双方都同意才可以发送cookie</p></li> <li><p>Access-Control-Expose-Headers
如果想要拿到<code>Cache-Control</code> <code>Content-language</code> <code>Content-type</code> <code>Expires</code> <code>Last-modified</code>以外的字段就需要通过该字段设置，
然后通过xhr的<code>getResponseHeader(HeaderName)</code>获取你想要的字段</p></li></ul> <h4 id="非简单请求"><a href="#非简单请求" class="header-anchor">#</a> 非简单请求</h4> <ul><li>请求方式是<code>put</code> <code>delete</code></li> <li>请求头<code>Content-Type</code>的值是application/json</li></ul> <p>浏览器会先发起一个option方法的预检请求preflight，询问服务器是否当前url是否在许可名单中，以及可以使用哪种http方法和头字段，<br>
浏览器发起预检</p> <ul><li><code>Origin</code></li> <li><code>Access-Control-Request-Method</code>，表示url要发起的http方法</li> <li><code>Access-Control-Request-Headers</code>需要额外发送的请求头
服务器收到预检请求</li> <li>检查<code>Origin</code>，<code>Access-Control-Request-Method</code>，<code>Access-Control-Request-Headers</code>的内容，判断是否允许跨域
服务器作出回应</li> <li>预检通过，浏览器发起正常的请求，返回<code>Origin</code>，<code>Access-Control-Request-Method</code>，<code>Access-Control-Request-Headers</code>允许的值</li> <li>预检不通过，会触发一个错误被xhr对象的onerror捕获
<br>
浏览器发起的预检通过后，就可以发起正常的网路请求</li></ul> <h3 id="nginx代理转发"><a href="#nginx代理转发" class="header-anchor">#</a> nginx代理转发</h3> <p>实现原理是跨域问题只存在浏览器之中，服务器之间的通信是没有同源限制，所以客户端先向自己所在的服务器发起请求也就是代理服务器，接着代理服务器和数据服务器通信<br>
这样浏览器就会以为是在同一个服务器中通信。<br></p> <p>以我曾经写过的一个项目为例，（ps：本地开启了switchHosts，所以当我在浏览器中输入自己的域名<code>music.72lsy.vip</code>，实则是访问本地的nginx服务<code>localhost</code>）<br>
localhost服务器部署vue项目，该项目请求的接口来源于qq音乐，但是由于跨域问题且无法修改对方的接口，所以选择使用nginx转发实现跨域<br></p> <h4 id="node服务"><a href="#node服务" class="header-anchor">#</a> node服务</h4> <p>node服务，里面的接口定义了一个<code>/api/getPurlUrl</code>的接口地址，内部再使用axios请求qq音乐的接口</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/getPurlUrl'</span><span class="token punctuation">,</span> bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://u.y.qq.com/cgi-bin/musicu.fcg'</span>
  axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      referer<span class="token operator">:</span> <span class="token string">'https://y.qq.com/'</span><span class="token punctuation">,</span>
      origin<span class="token operator">:</span> <span class="token string">'https://y.qq.com'</span><span class="token punctuation">,</span>
      <span class="token string">'Content-type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="前端配置"><a href="#前端配置" class="header-anchor">#</a> 前端配置</h4> <p>在vue项目中调用再请求<code>http://music.72lsy.vip/music/api/getPurlUrl</code>这个接口，增加了music是因为nginx服务器上我部署了多个项目<br></p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getSongsUrl</span><span class="token punctuation">(</span><span class="token parameter">songs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://music.72lsy.vip/music/api/getPurlUrl'</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">ERR_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token constant">ERR_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="nginx中配置代理"><a href="#nginx中配置代理" class="header-anchor">#</a> nginx中配置代理</h4> <p>当请求<code>music.72lsy.vip</code>时，包含有<code>music</code>的请求就会转发到本地的<code>localhost:9000</code></p> <div class="language-conf extra-class"><pre class="language-text"><code>server {
    listen       80;
    server_name music.72lsy.vip;
    autoindex on;
    #charset koi8-r;
    root /vue-music-h5/dist;
    index  index.html;
    location /music/ {
    proxy_pass http://127.0.0.1:9000/;
    }
}

</code></pre></div><h3 id="开发过程的跨域处理"><a href="#开发过程的跨域处理" class="header-anchor">#</a> 开发过程的跨域处理</h3> <p>以vue-cli提供的<code>proxyTable</code>为例，实际上是在本地开发时通过本地服务器代理到后端服务器接口，原理和nginx一致</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>dev<span class="token operator">:</span> <span class="token punctuation">{</span>
    proxyTable<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'api'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            target<span class="token operator">:</span> <span class="token string">'需要访问的跨域服务器'</span><span class="token punctuation">,</span>
            secure<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 如果跨域服务器是https</span>
            changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 如果设置为true，发送请求的host会变成target</span>
            pathReWrite<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;/api&quot;</span><span class="token operator">:</span> <span class="token string">&quot;替换成你需要修改的url部分&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Browser/safety/" class="prev">
        安全防范
      </a></span> <span class="next"><a href="/Browser/WhiteScreen/">
        白屏现象
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5ec938e9.js" defer></script><script src="/assets/js/2.270d282d.js" defer></script><script src="/assets/js/11.b810643b.js" defer></script>
  </body>
</html>
